## PEDSnet CDM V1

The PEDSnet common data model is based on the OMOP CDM V4. A full description of the data model is available in the [PEDSnet CDM V1](docs/PEDSnet CDM V1.docx) file. The PEDSnet CDM V1 documentation covers the tables from OMOP which have been part of PEDSnet operation up to this point, but the data definition language files here include all of the OMOP tables. Those tables not documented are still in a draft state. The following changes have been made to the OMOP data model in order to better accomodate the PEDSnet use case:

#### Field additions and deletions

1. Add `pn_time_of_birth` and `pn_gestational_age` fields to the `person` table.
2. Add `year_of_birth` field to the `provider` table.
3. Remove `place_of_service_concept_id` and `place_of_service_source_value` from the `visit_occurrence` table.
4. Add `provider_id`, `visit_type_concept_id` and `visit_source_value` to the `visit_occurrence` table.
5. Rename `units_source_value` to `unit_source_value` on the `observation` table.
6. Change field orders within some tables.

#### Null constraint changes

1. Make `care_site_id` on the `person` table `NOT NULL` for consistency in updates based on organization.
2. Make `care_site_source_value` on the `care_site` table `NOT NULL` for consistency in updates.
3. Make `organization_source_value` on the `organization` table `NOT NULL` for consistency in updates.
4. Make `provider_source_value` on the `provider` table `NOT NULL` for consistency in updates.
5. Make `visit_end_date` on the `visit_occurrence` table nullable to allow for visits which are ongoing at time of data extraction.

#### Data type changes

1. Increase many `VARCHAR` (or equivalent) max values to allow for more verbose data.
2. Change primary keys from `INTEGER` to `BIGINT` (or equivalent) to accomodate more data and automatically generate sequential values.
3. Change foreign keys from `INTEGER` to `BIGINT` (or equivalent) to match the `BIGINT` primary key data type.
4. Make primary keys auto-incrementing (except in Oracle) to emphasize that the values in those fields should not have any inherent meaning.
5. Interpret `DATE` types as strictly for storing dates without times.

#### Database compatibility

DDL scripts for creating the PEDSnet CDM V1 (and the rest of the OMOP tables, which are in draft state), are available for:

- PostgreSQL at [PEDSnet_CDM_V1_pgsql.ddl](PEDSnet_CDM_V1_pgsql.ddl)
- MySQL at [PEDSnet_CDM_V1_mysql.ddl](PEDSnet_CDM_V1_mysql.ddl)
- Oracle at [PEDSnet_CDM_V1_oracle.ddl](PEDSnet_CDM_V1_oracle.ddl)
- MS SQL Server at [PEDSnet_CDM_V1_mssql.ddl](PEDSnet_CDM_V1_mssql.ddl)

These scripts were generated by creating a declarative representation of the CDM using [SQLAlchemy](http://www.sqlalchemy.org/) syntax (in [sqlalchemy_tables.py](sqlalchemy_tables.py)) and programmatically converting it into dialect-specific DDL. For this reason, the scripts are not yet fully tested. Please report any issues [here](https://github.com/PEDSnet/Data_Models/issues).

DDL for the PEDSnet CDM V1 table and column comments (based on the OMOP CDM V4 comments) are available at [PEDSnet_CDM_V1_comments.ddl](PEDSnet_CDM_V1_comments.ddl). The syntax should work on PostgreSQL and Oracle, but not on MySQL or MS SQL Server.

To re-generate the DDL in the various dialects using the sqlalchemy table definition file:

1. Install python requirements with `pip install -r requirements.txt`
2. Run the generation script with `python generate_ddl_dialects.py`
